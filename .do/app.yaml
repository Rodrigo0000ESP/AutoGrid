name: autogrid
region: ams3

# Backend API Service
services:
  - name: backend-api
    source_dir: /backend
    github:
      repo: Rodrigo0000ESP/AutoGrid
      branch: main
      deploy_on_push: true
    
    run_command: gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8080
    
    environment_slug: python
    instance_count: 1
    instance_size_slug: basic-xxs
    
    http_port: 8080
    
    health_check:
      http_path: /health
    
    envs:
      # Database (auto-generated by DigitalOcean)
      - key: DB_URL
        scope: RUN_TIME
        value: ${autogrid-db.DATABASE_URL}
      
      # OpenAI
      - key: OPENAI_API_KEY
        scope: RUN_TIME
        type: SECRET
      
      # Stripe
      - key: STRIPE_SECRET_KEY
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_PUBLISHABLE_KEY
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_WEBHOOK_SECRET
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_PRO_PLAN_PRICE_ID
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_UNLIMITED_PLAN_PRICE_ID
        scope: RUN_TIME
        type: SECRET
      
      # Email Configuration
      - key: MAIL_USERNAME
        scope: RUN_TIME
        type: SECRET
      - key: MAIL_PASSWORD
        scope: RUN_TIME
        type: SECRET
      - key: MAIL_FROM
        value: autogridjob@gmail.com
      - key: MAIL_PORT
        value: "587"
      - key: MAIL_SERVER
        value: smtp.gmail.com
      - key: MAIL_FROM_NAME
        value: AutoGrid
      - key: MAIL_STARTTLS
        value: "True"
      - key: MAIL_SSL_TLS
        value: "False"
      
      # JWT Configuration
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "2880"
      
      # DigitalOcean Spaces
      - key: DO_SPACES_KEY
        scope: RUN_TIME
        type: SECRET
      - key: DO_SPACES_SECRET
        scope: RUN_TIME
        type: SECRET
      - key: DO_SPACES_BUCKET
        value: autogrid
      - key: DO_SPACES_REGION
        value: ams3
      - key: DO_SPACES_ENDPOINT
        value: https://ams3.digitaloceanspaces.com
      
      # File Upload
      - key: MAX_FILE_SIZE
        value: "10485760"
      
      # App Configuration
      - key: ENVIRONMENT
        value: production
      - key: FRONTEND_URL
        value: ${frontend-web.PUBLIC_URL}

# Frontend Web Service
  - name: frontend-web
    source_dir: /frontend
    github:
      repo: Rodrigo0000ESP/AutoGrid
      branch: main
      deploy_on_push: true
    
    build_command: npm install && npm run build
    run_command: npm run preview -- --host 0.0.0.0 --port 8080
    
    environment_slug: node-js
    instance_count: 1
    instance_size_slug: basic-xxs
    
    http_port: 8080
    
    envs:
      # Backend API URL (auto-generated)
      - key: PUBLIC_API_URL
        value: ${backend-api.PUBLIC_URL}
      
      # Stripe Public Keys
      - key: PUBLIC_STRIPE_PUBLIC_KEY
        scope: RUN_TIME
        type: SECRET
      - key: PUBLIC_STRIPE_PORTAL_LOGIN_URL
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_PRICE_ID_PRO
        scope: RUN_TIME
        type: SECRET
      - key: STRIPE_PRICE_ID_UNLIMITED
        scope: RUN_TIME
        type: SECRET

# Database
databases:
  - name: autogrid-db
    engine: PG
    version: "15"
    production: true
    cluster_name: autogrid-postgres
